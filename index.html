<!DOCTYPE html>
<html lang="ta">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Language Bridge Pro</title>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #701b76; color: white; text-align: center; margin: 0; padding: 10px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        #webcam-container { 
            margin: 15px auto; 
            border: 8px solid #1b7576; 
            border-radius: 20px; 
            width: 250px; 
            height: 250px; 
            background-color: #000; 
            overflow: hidden;
            position: relative;
        }
        
        canvas { width: 100% !important; height: 100% !important; object-fit: cover; }

        #label-container { font-size: 24px; font-weight: bold; color: #f1c40f; margin: 15px 0; min-height: 40px; }
        
        button { 
            padding: 15px 25px; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 18px; 
            width: 80%;
            margin: 10px 0;
            font-weight: bold;
        }
        button:active { background: #2980b9; transform: scale(0.98); }

        .reply-box { background: #1b7576; padding: 20px; border-radius: 15px; margin-top: 20px; }
        input { padding: 12px; width: 80%; border-radius: 5px; border: none; font-size: 16px; margin-bottom: 10px; }
        
        #signDisplay { display: none; margin: 20px auto; width: 280px; border-radius: 15px; border: 4px solid #f1c40f; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Sign Language Bridge ü§ù</h1>
        
        <div id="label-container">Loading Model...</div>
        
        <div id="webcam-container"></div>

        <button onclick="switchCamera()">üîÑ Switch Camera</button>

        <div class="reply-box">
            <h3>Text to Image</h3>
            <input type="text" id="ram-input" placeholder="Enter word...">
            <br>
            <button style="background:#283c47; width: 50%;" onclick="sendReply()">Show Sign</button>
        </div>

        <img id="signDisplay" src="" alt="Sign Image">
    </div>

    <script>
        const URL = "https://teachablemachine.withgoogle.com/models/XWj81Sbck/"; 
        let model, webcam, maxPredictions;
        let currentFacingMode = "environment"; // Start with Back Camera
        let lastSpoken = ""; // Voice repetition avoid panna

        // Voice Function
        function speak(text) {
            window.speechSynthesis.cancel(); // Stop previous voice
            let msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-US';
            window.speechSynthesis.speak(msg);
        }

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();
            await setupWebcam();
            window.requestAnimationFrame(loop);
        }

        async function setupWebcam() {
            const flip = (currentFacingMode === "user");
            webcam = new tmImage.Webcam(250, 250, flip);
            
            // Camera permissions check
            await webcam.setup({ facingMode: currentFacingMode }); 
            await webcam.play();

            const container = document.getElementById("webcam-container");
            container.innerHTML = ""; 
            container.appendChild(webcam.canvas);
        }

        // üõ†Ô∏è Fixed Switch Camera (Force Stop Tracks)
        async function switchCamera() {
            document.getElementById("label-container").innerText = "Switching... üîÑ";
            
            if (webcam) {
                await webcam.stop();
                // Direct access to stream to kill it completely
                if (webcam.canvas && webcam.canvas.srcObject) {
                    webcam.canvas.srcObject.getTracks().forEach(track => track.stop());
                }
            }

            // Change Mode
            currentFacingMode = (currentFacingMode === "user") ? "environment" : "user";
            
            // Re-init with delay
            setTimeout(async () => {
                try {
                    await setupWebcam();
                    document.getElementById("label-container").innerText = "Camera Ready ‚úÖ";
                } catch (err) {
                    alert("Camera Permission Error! Please refresh the page.");
                }
            }, 800); 
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let best = { className: "", prob: 0 };

            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > best.prob) {
                    best = { className: prediction[i].className, prob: prediction[i].probability };
                }
            }

            const label = document.getElementById("label-container");
            if (best.prob > 0.92) {
                label.innerText = "Detected: " + best.className;
                
                // Speak if new word
                if (best.className !== lastSpoken) {
                    speak(best.className);
                    lastSpoken = best.className;
                }
            } else {
                label.innerText = "Scanning...";
                lastSpoken = "";
            }
        }

        function sendReply() {
            let val = document.getElementById("ram-input").value.toLowerCase().trim();
            let img = document.getElementById("signDisplay");
            if(!val) return;
            img.style.display = "block";
            img.src = "image/" + val + ".jpg"; // Basic fallback logic
            img.onerror = () => { img.style.display="none"; alert("No Image!"); };
        }

        init();
    </script>
</body>
</html>
